## DMF_VirtualHidDeviceVhf

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Summary

-----------------------------------------------------------------------------------------------------------------------------------

This Module serves as a "base class" for Virtual HID devices. The Parent of the instance of this Module exposes a virtual HID
device.

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Configuration

-----------------------------------------------------------------------------------------------------------------------------------
##### DMF_CONFIG_VirtualHidDeviceVhf
Client uses this structure to configure the Module specific parameters.

````
typedef struct
{
  // Describe HID Device.
  // NOTE: In most cases this data is static memory so a pointer to that data
  //    is maintained. This prevents us from creating arbitrary size buffers.
  //
  USHORT VendorId;
  USHORT ProductId;
  USHORT VersionNumber;
  const UCHAR* HidReportDescriptor;
  ULONG HidReportDescriptorLength;
  HID_DEVICE_ATTRIBUTES HidDeviceAttributes;
  EVT_VHF_ASYNC_OPERATION* IoctlCallback_IOCTL_HID_SET_FEATURE;
  EVT_VHF_ASYNC_OPERATION* IoctlCallback_IOCTL_HID_GET_FEATURE;
  EVT_VHF_ASYNC_OPERATION* IoctlCallback_IOCTL_HID_GET_INPUT_REPORT;
  EVT_VHF_ASYNC_OPERATION* IoctlCallback_IOCTL_HID_WRITE_REPORT;
  EVT_VHF_READY_FOR_NEXT_READ_REPORT* IoctlCallback_IOCTL_HID_READ_REPORT;
  // This context will be passed by Vhf directly (from Vhf).
  //
  VOID* VhfClientContext;
  // Indicates that Vhf device should start when Module opens.
  //
  BOOLEAN StartOnOpen;
} DMF_CONFIG_VirtualHidDeviceVhf;
````
Member | Description
----|----
VendorId | The vendor id of the virtual HID device.
ProductId | The product id of the virtual HID device.
VersionNumber | The version number of the virtual HID device.
HidReportDescriptor | The HID report descriptor of the Virtual Hid device.
HidDeviceAttributes | The HID device attributes of the Virtual Hid device.
IoctlCallback_IOCTL_HID_SET_FEATURE | VHF callback for IOCTL_HID_SET_FEATURE.
IoctlCallback_IOCTL_HID_GET_FEATURE | VHF callback for IOCTL_HID_GET_FEATURE.
IoctlCallback_IOCTL_HID_GET_INPUT_REPORT | VHF callback for IOCTL_HID_GET_INPUT_REPORT.
IoctlCallback_IOCTL_HID_READ_REPORT | VHF callback for IOCTL_HID_READ_REPORT.
VhfClientContext | Usually this is set to the DMFMODULE of the Parent Module of this Module. This context is passed to the VHF callbacks above.
StartOnOpen | Indicates that streaming of requests to/from the devices start automatically when this Module opens.

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Enumeration Types

* None

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Structures

* None

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Callbacks

-----------------------------------------------------------------------------------------------------------------------------------

See MSDN documentation for how the VHF callbacks are used. Set the VhfClientContext member of this Module's Config to the
DMFMODULE of the Parent Module. Then the Parent Module can access its own Module Context in these callbacks.

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Methods

-----------------------------------------------------------------------------------------------------------------------------------

##### DMF_VirtualHidDeviceVhf_AsynchronousOperationComplete

````
_IRQL_requires_max_(DISPATCH_LEVEL)
VOID
DMF_VirtualHidDeviceVhf_AsynchronousOperationComplete(
  _In_ DMFMODULE DmfModule,
  _In_ VHFOPERATIONHANDLE VhfOperationHandle,
  _In_ NTSTATUS NtStatus
  );
````

Allows the Client to asynchronously respond to a previous request.

##### Returns

None

##### Parameters
Parameter | Description
----|----
DmfModule | An open DMF_VirtualHidDeviceVhf Module handle.
VhfOperationHandle | Indicates the previous request the Client is responding to.
NtStatus | The result of the previous request generated by the Client.
Remarks | * See MSDN VHF documentation for more information.

-----------------------------------------------------------------------------------------------------------------------------------

##### DMF_VirtualHidDeviceVhf_ReadReportSend

````
_IRQL_requires_max_(DISPATCH_LEVEL)
NTSTATUS
DMF_VirtualHidDeviceVhf_ReadReportSend(
  _In_ DMFMODULE DmfModule,
  _In_ HID_XFER_PACKET* HidTransferPacket
  );
````

Allows the Client to send a HID_READ_REPORT.

##### Returns

NTSTATUS

##### Parameters
Parameter | Description
----|----
DmfModule | An open DMF_VirtualHidDeviceVhf Module handle.
HidTransferPacket | Data that the Client sends in the HID_READ_REPORT.
Remarks | * See MSDN VHF documentation for more information.

-----------------------------------------------------------------------------------------------------------------------------------

#### Module IOCTLs

* None

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Remarks

* IMPORTANT: Vhf.sys must be set as a Lower Filter driver in the Client driver's INF file using the "LowerFilters" registry entry. Otherwise, the VHF API is not available and this Module's Open callback will fail.

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Children

* None

-----------------------------------------------------------------------------------------------------------------------------------

#### Module Implementation Details

-----------------------------------------------------------------------------------------------------------------------------------

#### Examples

* DMF_HidPortableDeviceButtons

-----------------------------------------------------------------------------------------------------------------------------------

#### To Do

-----------------------------------------------------------------------------------------------------------------------------------
#### Module Category

-----------------------------------------------------------------------------------------------------------------------------------

Hid

-----------------------------------------------------------------------------------------------------------------------------------

